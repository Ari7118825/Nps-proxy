<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Static Advanced Web Proxy</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --accent: #3b82f6;
            --text: #ffffff;
        }
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif;
            display: flex; flex-direction: column; overflow: hidden;
        }
        #nav {
            display: flex; align-items: center; padding: 10px 15px;
            background: #252525; border-bottom: 1px solid #333; gap: 10px;
        }
        #urlInput {
            flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #444;
            background: #000; color: #fff; outline: none; transition: border-color 0.2s;
        }
        #urlInput:focus { border-color: var(--accent); }
        button {
            padding: 10px 20px; border-radius: 6px; border: none;
            background: var(--accent); color: white; font-weight: bold;
            cursor: pointer; transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        #frameContainer { flex: 1; width: 100%; position: relative; background: #fff; }
        iframe { width: 100%; height: 100%; border: none; }
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: var(--accent); transform: scaleX(0); transform-origin: left;
            transition: transform 0.3s;
        }
    </style>
</head>
<body>

<div id="nav">
    <div style="font-weight: bold; color: var(--accent);">PROXY</div>
    <input type="text" id="urlInput" placeholder="https://example.com" onkeydown="if(event.key==='Enter') navigate()">
    <button onclick="navigate()">Go</button>
</div>

<div id="frameContainer">
    <div id="loader"></div>
    <iframe id="proxyFrame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
</div>

<script>
    const PROXY_API = "https://api.codetabs.com/v1/proxy?quest=";
    const frame = document.getElementById('proxyFrame');
    const input = document.getElementById('urlInput');
    const loader = document.getElementById('loader');

    async function navigate() {
        let url = input.value.trim();
        if (!url) return;
        if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
        
        showLoader(true);
        
        try {
            const response = await fetch(PROXY_API + encodeURIComponent(url));
            let html = await response.text();
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const urlObj = new URL(url);

            const fixUrl = (original) => {
                if (!original || typeof original !== 'string') return original;
                if (original.startsWith('data:') || original.startsWith('javascript:')) return original;
                try {
                    const resolved = new URL(original, urlObj.href).href;
                    if (resolved.startsWith(PROXY_API)) return resolved;
                    return PROXY_API + encodeURIComponent(resolved);
                } catch (e) {
                    return original;
                }
            };

            // 1. Initial Static Rewrite
            const attributesToFix = ['href', 'src', 'action', 'srcset', 'data-src'];
            doc.querySelectorAll('*').forEach(el => {
                attributesToFix.forEach(attr => {
                    if (el.hasAttribute(attr)) {
                        const val = el.getAttribute(attr);
                        if (val && !val.startsWith('#')) {
                            el.setAttribute(attr, fixUrl(val));
                        }
                    }
                });
            });

            // 2. Inject Advanced Interceptor
            const script = doc.createElement('script');
            script.textContent = `
                (function() {
                    const PROXY_API = "${PROXY_API}";
                    const BASE_URL = "${urlObj.href}";

                    function wrapUrl(url) {
                        if (!url || typeof url !== 'string') return url;
                        if (url.startsWith('data:') || url.startsWith('javascript:') || url.startsWith(PROXY_API)) return url;
                        try {
                            const resolved = new URL(url, BASE_URL).href;
                            return PROXY_API + encodeURIComponent(resolved);
                        } catch(e) { return url; }
                    }

                    // --- PATCH CORE APIS ---
                    const originalFetch = window.fetch;
                    window.fetch = function(resource, init) {
                        if (typeof resource === 'string') {
                            resource = wrapUrl(resource);
                        } else if (resource instanceof Request) {
                            resource = new Request(wrapUrl(resource.url), resource);
                        }
                        return originalFetch.call(this, resource, init);
                    };

                    const originalOpen = XMLHttpRequest.prototype.open;
                    XMLHttpRequest.prototype.open = function(method, url, ...args) {
                        return originalOpen.apply(this, [method, wrapUrl(url), ...args]);
                    };

                    // --- PATCH PROTOTYPES (For dynamic elements) ---
                    const descriptors = [
                        { obj: HTMLImageElement.prototype, prop: 'src' },
                        { obj: HTMLScriptElement.prototype, prop: 'src' },
                        { obj: HTMLIFrameElement.prototype, prop: 'src' },
                        { obj: HTMLLinkElement.prototype, prop: 'href' },
                        { obj: HTMLSourceElement.prototype, prop: 'src' },
                        { obj: HTMLSourceElement.prototype, prop: 'srcset' }
                    ];

                    descriptors.forEach(({ obj, prop }) => {
                        const originalDescriptor = Object.getOwnPropertyDescriptor(obj, prop);
                        Object.defineProperty(obj, prop, {
                            get: function() { return originalDescriptor.get.call(this); },
                            set: function(val) {
                                return originalDescriptor.set.call(this, wrapUrl(val));
                            },
                            configurable: true
                        });
                    });

                    // --- DOM WATCHER ---
                    const observer = new MutationObserver(mutations => {
                        mutations.forEach(mutation => {
                            mutation.addedNodes.forEach(node => {
                                if (node.nodeType === 1) { // Element
                                    if (node.tagName === 'A') {
                                        node.href = wrapUrl(node.href);
                                    } else if (node.src) {
                                        node.src = wrapUrl(node.src);
                                    }
                                }
                            });
                        });
                    });
                    observer.observe(document, { childList: true, subtree: true });

                    // Navigation Hooks for parent communication
                    document.addEventListener('click', e => {
                        const a = e.target.closest('a');
                        if (a && a.href && !a.href.startsWith('#')) {
                            const targetMatch = a.href.match(/quest=(.+)$/);
                            const finalUrl = targetMatch ? decodeURIComponent(targetMatch[1]) : a.href;
                            e.preventDefault();
                            window.parent.postMessage({ type: 'proxyNav', url: finalUrl }, '*');
                        }
                    });

                    document.addEventListener('submit', e => {
                        e.preventDefault();
                        const form = e.target;
                        const action = new URL(form.action, BASE_URL).href;
                        const formData = new URLSearchParams(new FormData(form)).toString();
                        const finalUrl = action + (action.includes('?') ? '&' : '?') + formData;
                        window.parent.postMessage({ type: 'proxyNav', url: finalUrl }, '*');
                    });
                })();
            `;
            doc.head.prepend(script);

            frame.srcdoc = doc.documentElement.outerHTML;
            
        } catch (err) {
            console.error("Proxy error:", err);
            alert("Could not load the page.");
        } finally {
            showLoader(false);
        }
    }

    window.addEventListener('message', e => {
        if (e.data && e.data.type === 'proxyNav') {
            input.value = e.data.url;
            navigate();
        }
    });

    function showLoader(show) {
        loader.style.transform = show ? 'scaleX(1)' : 'scaleX(0)';
    }
</script>

</body>
</html>
