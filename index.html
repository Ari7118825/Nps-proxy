<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple CodeTabs Proxy</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif; }
        #navbar { height: 50px; background: #333; display: flex; align-items: center; padding: 0 20px; color: white; }
        #url-input { flex-grow: 1; margin: 0 10px; padding: 5px; border-radius: 4px; border: none; }
        button { padding: 5px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        iframe { width: 100%; height: calc(100% - 50px); border: none; background: white; }
    </style>
</head>
<body>

<div id="navbar">
    <strong>Proxy:</strong>
    <input type="text" id="url-input" placeholder="https://example.com" value="https://example.com">
    <button onclick="loadPage()">Go</button>
</div>

<iframe id="viewer" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>

<script>
    const proxyApi = "https://api.codetabs.com/v1/proxy?quest=";
    const iframe = document.getElementById('viewer');
    const input = document.getElementById('url-input');

    async function loadPage() {
        let targetUrl = input.value.trim();
        if (!targetUrl.startsWith('http')) targetUrl = 'https://' + targetUrl;
        
        try {
            const response = await fetch(proxyApi + encodeURIComponent(targetUrl));
            let html = await response.text();
            
            // Rewrite URLs so links keep using the proxy
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const base = new URL(targetUrl);

            // Update all relative and absolute links
            const rewriteAttr = (tag, attr) => {
                doc.querySelectorAll(tag).forEach(el => {
                    const original = el.getAttribute(attr);
                    if (original && !original.startsWith('data:') && !original.startsWith('javascript:')) {
                        try {
                            const absolute = new URL(original, base).href;
                            // Set custom attribute to store original, then point to our function
                            el.setAttribute(attr, `javascript:parent.loadManual("${absolute}")`);
                        } catch(e) {}
                    }
                });
            };

            rewriteAttr('a', 'href');
            rewriteAttr('form', 'action');
            
            // For images and scripts, we just use CodeTabs directly
            doc.querySelectorAll('img, script, link').forEach(el => {
                const attr = el.tagName === 'LINK' ? 'href' : 'src';
                const original = el.getAttribute(attr);
                if (original) {
                    try {
                        const absolute = new URL(original, base).href;
                        el.setAttribute(attr, proxyApi + encodeURIComponent(absolute));
                    } catch(e) {}
                }
            });

            // Inject the modified HTML into the iframe
            const blob = new Blob([doc.documentElement.outerHTML], { type: 'text/html' });
            iframe.src = URL.createObjectURL(blob);

        } catch (err) {
            console.error("Proxy Error:", err);
            alert("Could not load page. CodeTabs might be rate-limited.");
        }
    }

    // Helper to allow links inside the iframe to trigger the parent loader
    window.loadManual = function(url) {
        input.value = url;
        loadPage();
    };

    // Allow "Enter" key to trigger search
    input.addEventListener("keypress", (e) => { if (e.key === "Enter") loadPage(); });
</script>

</body>
</html>
