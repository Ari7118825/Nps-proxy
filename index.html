<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Session-Persistent Proxy</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background: #121212; color: #fff; }
        #nav { height: 60px; background: #1e1e1e; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #333; }
        input { flex: 1; margin: 0 15px; padding: 10px; border-radius: 4px; border: 1px solid #444; background: #2b2b2b; color: white; }
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        #status { font-size: 11px; color: #888; width: 150px; overflow: hidden; }
        iframe { width: 100%; height: calc(100% - 61px); border: none; background: white; }
    </style>
</head>
<body>

<div id="nav">
    <strong>SessionProxy</strong>
    <input type="text" id="url-input" value="https://www.croxyproxy.com">
    <button onclick="launch()">Launch</button>
    <div id="status">Ready</div>
</div>

<iframe id="viewer" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>

<script>
    const viewer = document.getElementById('viewer');
    const statusBox = document.getElementById('status');
    const urlInput = document.getElementById('url-input');

    // Simple Cookie Jar using LocalStorage
    const CookieJar = {
        set: (url, cookieStr) => {
            const domain = new URL(url).hostname;
            localStorage.setItem(`cookie_${domain}`, cookieStr);
        },
        get: (url) => {
            const domain = new URL(url).hostname;
            return localStorage.getItem(`cookie_${domain}`) || "";
        }
    };

    async function launch() {
        loadUrl(urlInput.value);
    }

    async function loadUrl(targetUrl) {
        statusBox.innerText = "Fetching with Session...";
        
        try {
            // 1. Get saved cookies for this domain
            const savedCookies = CookieJar.get(targetUrl);

            // 2. Fetch using Puter.js (allows custom headers)
            const response = await puter.net.fetch(targetUrl, {
                method: 'GET',
                headers: {
                    'Cookie': savedCookies,
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0 Safari/537.36'
                }
            });

            // 3. Extract new cookies from response headers
            const setCookie = response.headers.get('set-cookie');
            if (setCookie) {
                CookieJar.set(targetUrl, setCookie);
            }

            const html = await response.text();
            statusBox.innerText = "Injecting Session...";
            render(html, targetUrl);

        } catch (err) {
            statusBox.innerText = "Error: " + err.message;
            console.error(err);
        }
    }

    function render(html, baseUrl) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const base = new URL(baseUrl);

        // Standard Rewriting Logic
        doc.querySelectorAll('a, form').forEach(el => {
            const attr = el.tagName === 'FORM' ? 'action' : 'href';
            const original = el.getAttribute(attr);
            if (original && !original.startsWith('#') && !original.startsWith('javascript:')) {
                try {
                    const absolute = new URL(original, base).href;
                    el.setAttribute(attr, `javascript:parent.loadManual("${absolute}")`);
                } catch(e) {}
            }
        });

        // Use a base tag to help with relative assets (CSS/Images)
        const baseTag = doc.createElement('base');
        baseTag.href = baseUrl;
        doc.head.insertBefore(baseTag, doc.head.firstChild);

        const blob = new Blob([doc.documentElement.outerHTML], { type: 'text/html' });
        viewer.src = URL.createObjectURL(blob);
        statusBox.innerText = "Connected";
    }

    window.loadManual = function(url) {
        urlInput.value = url;
        loadUrl(url);
    };
</script>

</body>
</html>
