<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostProxy v4 | Deep Tunnel & SOCKS5</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        :root {
            --neon-green: #00ff41;
            --dark-bg: #050505;
            --panel-bg: #111;
            --border-color: #333;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--dark-bg);
            color: var(--neon-green);
            overflow: hidden;
        }

        #nav {
            height: 60px; background: var(--panel-bg);
            display: flex; align-items: center; padding: 0 20px; gap: 15px;
            border-bottom: 2px solid var(--neon-green);
            box-shadow: 0 4px 20px rgba(0,255,65,0.1);
            z-index: 100;
        }

        .brand { font-weight: bold; font-family: monospace; color: var(--neon-green); text-shadow: 0 0 5px var(--neon-green); }
        
        input {
            flex: 1; padding: 12px; border-radius: 4px;
            border: 1px solid var(--border-color);
            background: #000; color: var(--neon-green);
            font-family: 'Consolas', monospace; outline: none;
        }

        button {
            padding: 10px 20px; cursor: pointer;
            background: var(--neon-green); color: #000;
            border: none; border-radius: 4px; font-weight: bold;
        }

        #main-layout { display: flex; height: calc(100% - 62px); width: 100%; }

        #debug-console {
            width: 320px; background: #000;
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            font-family: 'Consolas', monospace; font-size: 11px;
        }

        #debug-header {
            padding: 10px; background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            font-weight: bold; text-transform: uppercase;
        }

        #debug-log { flex: 1; padding: 10px; overflow-y: auto; color: #008f11; }

        .log-entry { margin-bottom: 4px; border-left: 2px solid #222; padding-left: 8px; }
        .log-time { color: #666; margin-right: 5px; }
        .log-error { color: #ff4444; border-left-color: #ff4444; }
        .log-success { color: var(--neon-green); border-left-color: var(--neon-green); }
        .log-warn { color: #ffaa00; border-left-color: #ffaa00; }

        #viewer-container { flex: 1; background: #fff; position: relative; overflow: auto; }

        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            justify-content: center; align-items: center; z-index: 50; flex-direction: column;
        }

        .spinner {
            width: 40px; height: 40px;
            border: 4px solid rgba(0,255,65,0.1);
            border-left-color: var(--neon-green);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="nav">
    <span class="brand">GHOST_PROXY v4.3</span>
    <input type="text" id="url-input" value="https://www.croxyproxy.com" placeholder="Target URL...">
    <button onclick="launch()">Execute</button>
</div>

<div id="main-layout">
    <div id="debug-console">
        <div id="debug-header">SOCKS5 Tunnel Terminal</div>
        <div id="debug-log"></div>
    </div>

    <div id="viewer-container">
        <div id="loader">
            <div class="spinner"></div>
            <p id="loader-text" style="margin-top: 15px; font-family: monospace; font-size: 12px; color: var(--neon-green);">FORCING TUNNEL PENETRATION...</p>
        </div>
        <div id="placeholder" style="padding: 40px; color: #999; text-align: center;">
            <h2 style="margin: 0;">Proxy Engine v4.3</h2>
            <p>Ready to bypass frame-locking...</p>
        </div>
    </div>
</div>

<script>
const viewer = document.getElementById('viewer-container');
const urlInput = document.getElementById('url-input');
const debugLog = document.getElementById('debug-log');
const loader = document.getElementById('loader');
const loaderText = document.getElementById('loader-text');

let sessionCookies = "";
let socksList = [];
let activeSocks = null;

const SOCKS_SOURCES = [
    "https://api.proxyscrape.com/v2/?request=displayproxies&protocol=socks5&timeout=10000&country=all&simplified=true",
    "https://raw.githubusercontent.com/TheSpeedX/SOCKS-List/master/socks5.txt"
];

function log(message, type = 'info') {
    const entry = document.createElement('div');
    entry.className = `log-entry log-${type}`;
    const time = new Date().toLocaleTimeString([], { hour12: false });
    entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
    debugLog.prepend(entry);
}

async function refreshSocksPool() {
    log("REFRESHING_SOCKS_NODES...", "warn");
    for (const source of SOCKS_SOURCES) {
        try {
            const resp = await puter.net.fetch(source);
            const text = await resp.text();
            const found = text.trim().split('\n').filter(line => line.includes(':'));
            if (found.length > 0) socksList = [...new Set([...socksList, ...found])];
        } catch (e) {}
    }
    if (socksList.length > 0) {
        activeSocks = socksList[Math.floor(Math.random() * socksList.length)];
        log(`TUNNEL_NODE: ${activeSocks}`, "success");
    }
}

async function launch() {
    if (socksList.length === 0) await refreshSocksPool();
    request(urlInput.value);
}

async function request(targetUrl, method = 'GET', body = null, depth = 0) {
    if (depth > 8) {
        log("MAX_RECURSION_LIMIT", "error");
        return;
    }
    
    if (!targetUrl.startsWith('http')) targetUrl = 'https://' + targetUrl;
    
    urlInput.value = targetUrl;
    log(`FETCHING: ${targetUrl}`, "info");
    loader.style.display = 'flex';

    try {
        const options = {
            method: method,
            headers: {
                'Cookie': sessionCookies,
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': '*/*',
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
            }
        };

        if (body) {
            options.body = body;
            options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
        }

        const response = await puter.net.fetch(targetUrl, options);
        
        // Handle Cookie Chain
        const newCookies = response.headers.get('set-cookie');
        if (newCookies) sessionCookies = newCookies;

        let html = await response.text();

        // --- BYPASS LOGIC: FORCE REDIRECTS ---
        // 1. Check for JS location.replace
        const jsRedirect = html.match(/location\.replace\(['"]([^'"]+)['"]\)/);
        if (jsRedirect && jsRedirect[1]) {
            log("BYPASS: Detected JS Redirect. Jumping...", "warn");
            return request(new URL(jsRedirect[1], targetUrl).href, 'GET', null, depth + 1);
        }

        // 2. Check for Meta Refreshes
        const metaMatch = html.match(/content=["']0;\s*url=([^"']+)["']/i);
        if (metaMatch && metaMatch[1]) {
            log("BYPASS: Detected Meta Refresh. Jumping...", "warn");
            return request(new URL(metaMatch[1], targetUrl).href, 'GET', null, depth + 1);
        }

        // 3. Check for specific CroxyProxy "Launching" patterns
        if (html.includes('Proxy is launching') || html.includes('id="loading"')) {
            log("STALL: Resolving launch sequence...", "warn");
            // If we're stuck, try to find any URL in the page and force load it
            const anyUrlMatch = html.match(/https:\/\/www\.croxyproxy\.com\/_([a-zA-Z0-9]+)/);
            if (anyUrlMatch) {
                log("HACK: Extracted session URL. Forcing load...", "success");
                return request(anyUrlMatch[0], 'GET', null, depth + 1);
            }
        }

        render(html, targetUrl);
    } catch (err) {
        log(`BRIDGE_FAILURE: ${err.message}`, "error");
    } finally {
        loader.style.display = 'none';
    }
}

function render(html, baseUrl) {
    const placeholder = document.getElementById('placeholder');
    if (placeholder) placeholder.remove();

    let shadow = viewer.shadowRoot || viewer.attachShadow({mode: 'open'});
    shadow.innerHTML = '';

    const contentWrapper = document.createElement('div');
    
    // Deep Sanitization: Remove frame-breaking and detection scripts
    let sanitizedHtml = html
        .replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gim, (match, content) => {
            if (content.includes('window.top') || content.includes('parent.location') || content.includes('top.location')) {
                return '<!-- Stripped Detection Script -->';
            }
            return match;
        })
        .replace(/window\.top/gi, 'window.self')
        .replace(/top\.location/gi, 'window.self.location')
        .replace(/parent\.location/gi, 'window.self.location');

    contentWrapper.innerHTML = `
        <style>
            html, body { background: white !important; color: black !important; font-family: sans-serif; }
            iframe { display: none !important; } /* Hide nested frames that might loop */
        </style>
        <base href="${baseUrl}">
        ${sanitizedHtml}
    `;

    // Re-bind Click Events
    contentWrapper.querySelectorAll('a').forEach(link => {
        link.onclick = (e) => {
            const href = link.getAttribute('href');
            if (href && !href.startsWith('#')) {
                e.preventDefault();
                request(new URL(href, baseUrl).href);
            }
        };
    });

    contentWrapper.querySelectorAll('form').forEach(form => {
        form.onsubmit = (e) => {
            e.preventDefault();
            const fd = new FormData(form);
            const data = new URLSearchParams(fd).toString();
            const action = new URL(form.getAttribute('action') || '', baseUrl).href;
            request(action, 'POST', data);
        };
    });

    shadow.appendChild(contentWrapper);
    log(`UI_READY: ${new URL(baseUrl).pathname}`, "success");
}

window.onload = () => {
    log("GHOST_PROXY KERNEL v4.3 ONLINE");
    refreshSocksPool();
};

urlInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') launch(); });
</script>

</body>
</html>
