<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GhostProxy | Hardened</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background: #000; color: #fff; overflow: hidden; }
        #nav { height: 50px; background: #111; display: flex; align-items: center; padding: 0 15px; gap: 10px; border-bottom: 2px solid #333; }
        input { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #111; color: #0f0; font-family: monospace; }
        button { padding: 8px 15px; cursor: pointer; background: #222; color: #0f0; border: 1px solid #0f0; border-radius: 4px; font-weight: bold; }
        #status { font-size: 11px; color: #666; width: 100px; overflow: hidden; }
        iframe { width: 100%; height: calc(100% - 52px); border: none; background: white; }
    </style>
</head>
<body>

<div id="nav">
    <strong>GHOST:</strong>
    <input type="text" id="url-input" value="https://www.croxyproxy.com">
    <button onclick="launch()">TNL_START</button>
    <div id="status">IDLE</div>
</div>

<iframe id="viewer" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe>

<script>
    const viewer = document.getElementById('viewer');
    const urlInput = document.getElementById('url-input');
    const statusBox = document.getElementById('status');
    let sessionCookies = "";

    async function launch() {
        request(urlInput.value);
    }

    async function request(targetUrl, method = 'GET', body = null) {
        statusBox.innerText = "TUNNELING...";
        try {
            const options = {
                method: method,
                headers: { 'Cookie': sessionCookies, 'Referer': 'https://www.croxyproxy.com/' }
            };
            if (body) {
                options.body = body;
                options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
            }

            const response = await puter.net.fetch(targetUrl, options);
            const newCookies = response.headers.get('set-cookie');
            if (newCookies) sessionCookies = newCookies;

            let html = await response.text();
            
            // Rewrite strings that scripts use to find the top window
            html = html.replace(/window\.top/g, 'window.self');
            html = html.replace(/top\.location/g, 'window.self.location');
            html = html.replace(/parent\.location/g, 'window.self.location');

            render(html, targetUrl);
            statusBox.innerText = "TUNNEL_OPEN";
        } catch (err) {
            statusBox.innerText = "ERR_FAIL";
        }
    }

    function render(html, baseUrl) {
        const injection = `
            <script>
                (function() {
                    // Force window.top to refer to this frame only
                    Object.defineProperty(window, 'top', { get: () => window.self });
                    Object.defineProperty(window, 'parent', { get: () => window.self });

                    // Block location changes via Proxy
                    const handleUrl = (url) => {
                        const target = new URL(url, "${baseUrl}").href;
                        parent.postMessage({type: 'nav', url: target}, '*');
                    };

                    // Intercept any script-based navigation
                    const originalReplace = window.location.replace;
                    window.location.replace = function(url) { handleUrl(url); };
                    
                    // Trap Click Events
                    document.addEventListener('click', e => {
                        const a = e.target.closest('a');
                        if (a && a.href && !a.href.startsWith('javascript:')) {
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            handleUrl(a.href);
                        }
                    }, true);

                    // Trap Form Submits
                    document.addEventListener('submit', e => {
                        e.preventDefault();
                        const fd = new FormData(e.target);
                        const data = new URLSearchParams(fd).toString();
                        parent.postMessage({type: 'form', url: e.target.action, data: data}, '*');
                    }, true);

                    // MutationObserver to stop dynamic "Break-out" scripts
                    new MutationObserver(mutations => {
                        mutations.forEach(m => {
                            m.addedNodes.forEach(node => {
                                if (node.tagName === 'SCRIPT' && node.innerHTML.includes('top.location')) {
                                    node.innerHTML = node.innerHTML.replace(/top\.location/g, 'window.self.location');
                                }
                            });
                        });
                    }).observe(document.documentElement, { childList: true, subtree: true });

                })();
            <\/script>
            <base href="${baseUrl}">
        `;

        const finalHtml = injection + html;
        const blob = new Blob([finalHtml], { type: 'text/html' });
        if(viewer.src) URL.revokeObjectURL(viewer.src);
        viewer.src = URL.createObjectURL(blob);
    }

    window.addEventListener('message', e => {
        if (e.data.type === 'nav') {
            urlInput.value = e.data.url;
            request(e.data.url);
        } else if (e.data.type === 'form') {
            request(e.data.url, 'POST', e.data.data);
        }
    });
</script>
</body>
</html>
