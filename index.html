<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Intercept Proxy</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background: #111; color: #fff; overflow: hidden; }
        #nav { height: 50px; background: #222; display: flex; align-items: center; padding: 0 15px; gap: 10px; border-bottom: 2px solid #444; }
        input { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #000; color: #0f0; font-family: monospace; }
        button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; }
        #status { font-size: 11px; color: #888; white-space: nowrap; }
        iframe { width: 100%; height: calc(100% - 52px); border: none; background: white; }
    </style>
</head>
<body>

<div id="nav">
    <strong>GhostProxy:</strong>
    <input type="text" id="url-input" value="https://www.croxyproxy.com">
    <button onclick="launch()">Launch</button>
    <div id="status">IDLE</div>
</div>

<iframe id="viewer" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>

<script>
    const viewer = document.getElementById('viewer');
    const urlInput = document.getElementById('url-input');
    const statusBox = document.getElementById('status');

    let sessionCookies = "";

    async function launch() {
        request(urlInput.value);
    }

    async function request(targetUrl, method = 'GET', body = null) {
        statusBox.innerText = `FETCHING: ${targetUrl.substring(0, 30)}...`;
        
        try {
            const options = {
                method: method,
                headers: {
                    'Cookie': sessionCookies,
                    'Referer': 'https://www.croxyproxy.com/'
                }
            };
            if (body) {
                options.body = body;
                options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
            }

            const response = await puter.net.fetch(targetUrl, options);
            
            // Sync Cookies
            const newCookies = response.headers.get('set-cookie');
            if (newCookies) sessionCookies = newCookies;

            const html = await response.text();
            render(html, targetUrl);
            statusBox.innerText = "ACTIVE SESSION";
        } catch (err) {
            statusBox.innerText = "FAILED";
            console.error(err);
        }
    }

    function render(html, baseUrl) {
        const base = new URL(baseUrl);
        
        // This script will be injected into the TOP of the iframe HTML
        // It hijacks the JS environment to prevent direct escapes
        const injection = `
            <script>
                (function() {
                    const originalLocation = window.location.href;
                    
                    // Hijack Links
                    document.addEventListener('click', e => {
                        const anchor = e.target.closest('a');
                        if (anchor && anchor.href && !anchor.href.startsWith('javascript:')) {
                            e.preventDefault();
                            parent.postMessage({type: 'nav', url: anchor.href}, '*');
                        }
                    }, true);

                    // Hijack Forms
                    document.addEventListener('submit', e => {
                        e.preventDefault();
                        const form = e.target;
                        const formData = new FormData(form);
                        const params = new URLSearchParams(formData).toString();
                        const action = new URL(form.action || '', "${baseUrl}").href;
                        parent.postMessage({type: 'form', url: action, data: params}, '*');
                    }, true);

                    // Block window.location changes
                    Object.defineProperty(window, 'location', {
                        set: function(val) {
                            parent.postMessage({type: 'nav', url: new URL(val, "${baseUrl}").href}, '*');
                        }
                    });
                })();
            <\/script>
            <base href="${baseUrl}">
        `;

        const finalHtml = injection + html;
        const blob = new Blob([finalHtml], { type: 'text/html' });
        viewer.src = URL.createObjectURL(blob);
    }

    // Listen for messages from the injected script inside the iframe
    window.addEventListener('message', e => {
        if (e.data.type === 'nav') {
            urlInput.value = e.data.url;
            request(e.data.url);
        } else if (e.data.type === 'form') {
            urlInput.value = e.data.url;
            request(e.data.url, 'POST', e.data.data);
        }
    });

    // Handle "Manual" navigation for rewriting
    window.loadManual = (url) => {
        urlInput.value = url;
        request(url);
    }
</script>

</body>
</html>
